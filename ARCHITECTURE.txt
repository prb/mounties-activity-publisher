═══════════════════════════════════════════════════════════════════════════════
  MOUNTAINEERS ACTIVITIES DISCORD PUBLISHER - ARCHITECTURE
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                              TRIGGERS                                       │
│                                                                             │
│  ┌──────────────────┐                     ┌──────────────────┐            │
│  │ Cloud Scheduler  │                     │ Cloud Scheduler  │            │
│  │   (hourly :00)   │                     │   (hourly :30)   │            │
│  └────────┬─────────┘                     └────────┬─────────┘            │
│           │ HTTP POST                              │ HTTP POST             │
│           │ (OIDC auth)                            │ (OIDC auth)           │
│           ▼                                        ▼                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            SEARCH PHASE                                     │
│                                                                             │
│  ┌──────────────────┐          ┌─────────────────┐                        │
│  │   Mountaineers   │◄─────────│    Searcher     │                        │
│  │     Website      │  GET     │    Function     │                        │
│  │ (Search Results) │          └────────┬────────┘                        │
│  └──────────────────┘                   │                                  │
│                                          │ update status                    │
│                            ┌─────────────▼──────────────┐                  │
│                            │       Firestore            │                  │
│                            │  ┌──────────────────────┐  │                  │
│                            │  │ bookkeeping          │  │                  │
│                            │  │   - search_status    │  │                  │
│                            │  │   - last_success     │  │                  │
│                            │  └──────────────────────┘  │                  │
│                            └─────────────────────────────┘                  │
│                                          │                                  │
│                                          │ enqueue tasks                    │
│                                          ▼                                  │
│                         ┌─────────────────────────────┐                    │
│                         │   search-queue (10/min)     │─┐ pagination       │
│                         │   scrape-queue (30/min)     │ │                  │
│                         └─────────────────────────────┘ │                  │
│                                          │               │                  │
│                                          └───────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           SCRAPE PHASE                                      │
│                                                                             │
│  ┌──────────────────┐          ┌─────────────────┐                        │
│  │   Mountaineers   │◄─────────│    Scraper      │                        │
│  │     Website      │  GET     │    Function     │                        │
│  │ (Activity Detail)│          └────────┬────────┘                        │
│  └──────────────────┘                   │                                  │
│                                          │ store                            │
│                            ┌─────────────▼──────────────┐                  │
│                            │       Firestore            │                  │
│                            │  ┌──────────────────────┐  │                  │
│                            │  │ activities           │  │                  │
│                            │  │   - title            │  │                  │
│                            │  │   - date             │  │                  │
│                            │  │   - activity_type    │  │                  │
│                            │  │   - leader_ref       │  │                  │
│                            │  │   - place_ref        │  │                  │
│                            │  │   - discord_msg_id   │  │                  │
│                            │  └──────────────────────┘  │                  │
│                            │  ┌──────────────────────┐  │                  │
│                            │  │ leaders              │  │                  │
│                            │  └──────────────────────┘  │                  │
│                            │  ┌──────────────────────┐  │                  │
│                            │  │ places               │  │                  │
│                            │  └──────────────────────┘  │                  │
│                            │  ┌──────────────────────┐  │                  │
│                            │  │ bookkeeping          │  │                  │
│                            │  │   - scrape_status    │  │                  │
│                            │  │   - last_success     │  │                  │
│                            │  └──────────────────────┘  │                  │
│                            └─────────────────────────────┘                  │
│                                          │                                  │
│                                          │ enqueue task                     │
│                                          ▼                                  │
│                         ┌─────────────────────────────┐                    │
│                         │  publish-queue (5/min)      │                    │
│                         └─────────────────────────────┘                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          PUBLISH PHASE                                      │
│                                                                             │
│                         ┌─────────────────┐                                │
│                         │   Publisher     │                                │
│                         │   Function      │                                │
│                         └────────┬────────┘                                │
│                                  │                                          │
│                    ┌─────────────┼─────────────┐                           │
│                    │             │             │                           │
│         get activity     get bot token    POST message                     │
│                    │             │             │                           │
│                    ▼             ▼             ▼                           │
│          ┌──────────────┐ ┌────────────┐ ┌─────────────┐                 │
│          │  Firestore   │ │  Secret    │ │   Discord   │                 │
│          │  activities  │ │  Manager   │ │   Channel   │                 │
│          └──────────────┘ └────────────┘ └─────────────┘                 │
│                    │                                                        │
│                    │ update discord_message_id & bookkeeping               │
│                    ▼                                                        │
│          ┌──────────────┐                                                  │
│          │  Firestore   │                                                  │
│          └──────────────┘                                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                        CATCHUP PHASE                                        │
│                                                                             │
│                   ┌─────────────────────────┐                              │
│                   │  Publishing Catchup     │                              │
│                   │      Function           │                              │
│                   └────────┬────────────────┘                              │
│                            │                                                │
│                            │ query unpublished activities                  │
│                            │                                                │
│                            ▼                                                │
│                   ┌─────────────────┐                                      │
│                   │   Firestore     │                                      │
│                   │   activities    │                                      │
│                   │ (discord_msg_id │                                      │
│                   │    = null)      │                                      │
│                   └─────────────────┘                                      │
│                            │                                                │
│                            │ enqueue activity IDs                          │
│                            ▼                                                │
│                   ┌─────────────────────────────┐                          │
│                   │  publish-queue (5/min)      │                          │
│                   └─────────────────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════
  SECURITY & AUTHENTICATION
═══════════════════════════════════════════════════════════════════════════════

  Cloud Scheduler → Functions:
    • OIDC token authentication
    • Service Account: scheduler-invoker@{project}.iam.gserviceaccount.com
    • Role: Cloud Run Invoker

  Cloud Tasks → Functions:
    • OIDC token authentication
    • Service Account: {project}@appspot.gserviceaccount.com
    • Role: Cloud Run Invoker

  All functions:
    • Cloud Functions Gen2 (built on Cloud Run)
    • Deployed with --no-allow-unauthenticated
    • Require IAM authentication for all invocations

═══════════════════════════════════════════════════════════════════════════════
  KEY METRICS
═══════════════════════════════════════════════════════════════════════════════

  Cloud Functions:
    • searcher:           ~720 invocations/month   (512MB, 540s timeout)
    • scraper:            ~10,000 invocations/month (512MB, 540s timeout)
    • publisher:          ~10,000 invocations/month (256MB, 540s timeout)
    • publishing-catchup: ~720 invocations/month   (256MB, 540s timeout)

  Cloud Tasks Queues:
    • search-queue:  10 dispatches/min, 1 concurrent, 3 retries
    • scrape-queue:  30 dispatches/min, 5 concurrent, 3 retries
    • publish-queue: 5 dispatches/min, 1 concurrent, 3 retries

  Firestore Collections:
    • activities:   ~14 new documents per poll
    • leaders:      ~5-10 documents (deduplicated)
    • places:       ~5-10 documents (deduplicated)
    • bookkeeping:  1 document (status tracking)

  Total Cost: $0/month (within free tier limits)

═══════════════════════════════════════════════════════════════════════════════
